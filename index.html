<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Visualización 3D de Edificios - OpenStreetMap</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        #myDiv {
            width: 100%;
            height: 700px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls {
            margin-top: 20px;
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            margin: 5px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .info {
            margin: 20px 0;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 4px;
            text-align: center;
        }
        .stats {
            display: inline-block;
            margin: 0 20px;
        }
        .data-input {
            margin: 20px auto;
            max-width: 800px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
        .load-btn {
            background: #28a745;
            margin-top: 10px;
        }
        .load-btn:hover {
            background: #218838;
        }
        .legend {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 12px;
            max-width: 200px;
        }
    </style>
</head>
<body>
    <h1>🏢 Visualización 3D de Edificios - Ciudad de México</h1>
    
    <div class="data-input">
        <h3>Cargar datos de n8n:</h3>
        <textarea id="dataInput" placeholder='Pega aquí los datos JSON de n8n en el formato:
{
  "buildingsCount": 10,
  "centerCoordinates": {"lat": 19.4326, "lon": -99.1332},
  "plotData": {
    "x": [100, 200, 300],
    "y": [100, 200, 300],
    "z": [0, 0, 0],
    "heights": [50, 75, 100],
    "labels": ["Edificio 1", "Edificio 2", "Edificio 3"],
    "colors": [50, 75, 100]
  }
}'></textarea>
        <br>
        <button class="load-btn" onclick="loadData()">Cargar y Visualizar</button>
        <button onclick="loadSampleData()">Cargar Datos de Ejemplo</button>
    </div>
    
    <div class="info">
        <div class="stats">
            <strong>Edificios cargados:</strong> <span id="buildingCount">0</span>
        </div>
        <div class="stats">
            <strong>Centro:</strong> <span id="centerCoords">0.000000, 0.000000</span>
        </div>
    </div>
    
    <div id="myDiv"></div>
    
    <div class="controls">
        <button onclick="resetView()">Vista Inicial</button>
        <button onclick="topView()">Vista Superior</button>
        <button onclick="sideView()">Vista Lateral</button>
        <button onclick="saveImage()">Guardar Imagen</button>
        <button onclick="toggleSpin()">Rotación Auto</button>
    </div>
    
    <div class="legend">
        <strong>Atajos de teclado:</strong><br>
        R - Vista inicial<br>
        T - Vista superior<br>
        S - Vista lateral<br>
        Espacio - Rotación automática
    </div>
    
    <script>
        let plotData = null;
        let centerCoords = { lat: 19.4326, lon: -99.1332 };
        let spinning = false;
        let spinInterval;
        let currentAngle = 0;
        
        function loadSampleData() {
            const sampleData = {
                buildingsCount: 5,
                centerCoordinates: { lat: 19.4326, lon: -99.1332 },
                plotData: {
                    x: [0, 100, -100, 200, -200],
                    y: [0, 100, -100, -200, 200],
                    z: [0, 0, 0, 0, 0],
                    heights: [80, 120, 60, 150, 90],
                    labels: ["Torre Central", "Edificio Norte", "Edificio Sur", "Torre Este", "Torre Oeste"],
                    colors: [80, 120, 60, 150, 90]
                }
            };
            
            document.getElementById('dataInput').value = JSON.stringify(sampleData, null, 2);
            processData(sampleData);
        }
        
        function loadData() {
            try {
                const inputData = document.getElementById('dataInput').value.trim();
                if (!inputData) {
                    alert('Por favor, introduce los datos JSON.');
                    return;
                }
                
                const data = JSON.parse(inputData);
                processData(data);
            } catch (error) {
                alert('Error al procesar los datos JSON: ' + error.message);
                console.error('Error:', error);
            }
        }
        
        function processData(data) {
            // Validar estructura de datos
            if (!data.plotData || !data.plotData.x || !data.plotData.y || !data.plotData.heights) {
                alert('Los datos no tienen la estructura correcta. Faltan campos: x, y, heights');
                return;
            }
            
            plotData = data.plotData;
            centerCoords = data.centerCoordinates || centerCoords;
            
            // Actualizar información en pantalla
            document.getElementById('buildingCount').textContent = data.buildingsCount || plotData.x.length;
            document.getElementById('centerCoords').textContent = 
                `${centerCoords.lat.toFixed(6)}, ${centerCoords.lon.toFixed(6)}`;
            
            // Crear visualización
            createVisualization();
        }
        
        function createVisualization() {
            if (typeof Plotly === 'undefined') {
                showErrorMessage('Plotly.js no se ha cargado correctamente. Por favor, recarga la página.');
                return;
            }
            
            if (!plotData || !plotData.x || plotData.x.length === 0) {
                showNoDataMessage();
                return;
            }
            
            console.log('Creando visualización con datos:', {
                edificios: plotData.x.length,
                alturaMaxima: Math.max(...plotData.heights),
                alturaMinima: Math.min(...plotData.heights)
            });
            
            const data = [];
            const buildingSize = 20; // metros
            
            // Crear edificios como cubos 3D
            for (let i = 0; i < plotData.x.length; i++) {
                const x = plotData.x[i];
                const y = plotData.y[i];
                const height = plotData.heights[i];
                const halfSize = buildingSize / 2;
                
                // Crear superficie del edificio (mesh3d)
                const surfaceTrace = {
                    type: 'mesh3d',
                    x: [x-halfSize, x+halfSize, x+halfSize, x-halfSize, x-halfSize, x+halfSize, x+halfSize, x-halfSize],
                    y: [y-halfSize, y-halfSize, y+halfSize, y+halfSize, y-halfSize, y-halfSize, y+halfSize, y+halfSize],
                    z: [0, 0, 0, 0, height, height, height, height],
                    i: [0, 0, 0, 0, 4, 4, 4, 4, 0, 1, 2, 3],
                    j: [1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 3, 0],
                    k: [5, 6, 7, 7, 1, 2, 3, 3, 4, 5, 6, 7],
                    color: `hsl(${Math.min(height * 2, 360)}, 70%, 50%)`,
                    opacity: 0.8,
                    name: plotData.labels ? plotData.labels[i] : `Edificio ${i+1}`,
                    showlegend: false,
                    hovertemplate: 
                        '<b>%{fullData.name}</b><br>' +
                        'Altura: ' + height + 'm<br>' +
                        'Posición: (' + x.toFixed(1) + ', ' + y.toFixed(1) + ')<br>' +
                        '<extra></extra>'
                };
                
                data.push(surfaceTrace);
            }
            
            // Añadir marcadores en la cima de cada edificio con etiquetas
            if (plotData.labels) {
                const labelTrace = {
                    type: 'scatter3d',
                    mode: 'markers+text',
                    x: plotData.x,
                    y: plotData.y,
                    z: plotData.heights.map(h => h + 10),
                    text: plotData.labels,
                    textposition: 'top center',
                    textfont: {
                        size: 12,
                        color: '#000'
                    },
                    marker: {
                        size: 8,
                        color: plotData.colors || plotData.heights,
                        colorscale: 'Viridis',
                        showscale: true,
                        colorbar: {
                            title: 'Altura (m)',
                            thickness: 20,
                            len: 0.5
                        }
                    },
                    name: 'Edificios',
                    showlegend: false,
                    hovertemplate: 
                        '<b>%{text}</b><br>' +
                        'Altura: %{marker.color:.1f}m<br>' +
                        'Posición: (%{x:.1f}, %{y:.1f})<br>' +
                        '<extra></extra>'
                };
                
                data.push(labelTrace);
            }
            
            // Añadir plano base
            const maxRange = Math.max(
                Math.max(...plotData.x) - Math.min(...plotData.x),
                Math.max(...plotData.y) - Math.min(...plotData.y)
            );
            const gridSize = Math.max(maxRange / 2, 200);
            
            const gridTrace = {
                type: 'mesh3d',
                x: [-gridSize, gridSize, gridSize, -gridSize],
                y: [-gridSize, -gridSize, gridSize, gridSize],
                z: [-1, -1, -1, -1],
                i: [0, 0],
                j: [1, 2],
                k: [2, 3],
                color: '#e0e0e0',
                opacity: 0.3,
                showlegend: false,
                hoverinfo: 'skip'
            };
            
            data.push(gridTrace);
            
            // Configuración del layout
            const layout = {
                title: {
                    text: 'Vista 3D de Edificios - OpenStreetMap',
                    font: { size: 24 }
                },
                scene: {
                    xaxis: {
                        title: 'Este-Oeste (metros)',
                        gridcolor: '#bbb',
                        showbackground: true,
                        backgroundcolor: '#f0f0f0'
                    },
                    yaxis: {
                        title: 'Norte-Sur (metros)',
                        gridcolor: '#bbb',
                        showbackground: true,
                        backgroundcolor: '#f0f0f0'
                    },
                    zaxis: {
                        title: 'Altura (metros)',
                        gridcolor: '#bbb',
                        showbackground: true,
                        backgroundcolor: '#f0f0f0'
                    },
                    camera: {
                        eye: {
                            x: 1.5,
                            y: -1.5,
                            z: 1.2
                        },
                        center: {
                            x: 0,
                            y: 0,
                            z: 0
                        }
                    },
                    aspectmode: 'manual',
                    aspectratio: {
                        x: 1,
                        y: 1,
                        z: 0.5
                    }
                },
                autosize: true,
                margin: { l: 0, r: 0, b: 0, t: 40 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                showlegend: false
            };
            
            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                toImageButtonOptions: {
                    format: 'png',
                    filename: 'edificios_3d',
                    height: 1080,
                    width: 1920,
                    scale: 2
                }
            };
            
            // Crear el gráfico
            Plotly.newPlot('myDiv', data, layout, config);
            
            // Auto-ajustar vista
            setTimeout(autoAdjustView, 100);
            
            // Mostrar estadísticas
            showStatistics();
        }
        
        function showErrorMessage(message) {
            document.getElementById('myDiv').innerHTML = 
                '<div style="text-align: center; padding: 50px; color: #d32f2f; background: #ffebee; border-radius: 8px; margin: 20px;">' +
                '<h2>❌ Error</h2>' +
                '<p>' + message + '</p>' +
                '<button onclick="location.reload()" style="margin-top: 10px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Recargar Página</button>' +
                '</div>';
        }
        
        function showNoDataMessage() {
            document.getElementById('myDiv').innerHTML = 
                '<div style="text-align: center; padding: 50px; color: #666;">' +
                '<h2>No hay datos de edificios</h2>' +
                '<p>Por favor, carga los datos JSON desde n8n o usa los datos de ejemplo.</p>' +
                '</div>';
        }
        
        function showStatistics() {
            if (!plotData || !plotData.heights) return;
            
            const avgHeight = plotData.heights.reduce((a, b) => a + b, 0) / plotData.heights.length;
            const statsDiv = document.createElement('div');
            statsDiv.style.cssText = 'margin: 20px auto; padding: 15px; background: #fff3cd; border-radius: 4px; max-width: 600px; text-align: center;';
            statsDiv.innerHTML = `
                <strong>Estadísticas:</strong><br>
                Total edificios: ${plotData.x.length}<br>
                Altura promedio: ${avgHeight.toFixed(1)}m<br>
                Altura máxima: ${Math.max(...plotData.heights)}m<br>
                Altura mínima: ${Math.min(...plotData.heights)}m
            `;
            
            // Remover estadísticas anteriores
            const existingStats = document.querySelector('.info .stats-summary');
            if (existingStats) existingStats.remove();
            
            statsDiv.className = 'stats-summary';
            document.querySelector('.info').appendChild(statsDiv);
        }
        
        // Funciones de control de vista
        function resetView() {
            if (typeof Plotly === 'undefined') return;
            Plotly.relayout('myDiv', {
                'scene.camera': {
                    eye: { x: 1.5, y: -1.5, z: 1.2 },
                    center: { x: 0, y: 0, z: 0 }
                }
            });
        }
        
        function topView() {
            if (typeof Plotly === 'undefined') return;
            Plotly.relayout('myDiv', {
                'scene.camera': {
                    eye: { x: 0, y: 0, z: 2.5 },
                    center: { x: 0, y: 0, z: 0 }
                }
            });
        }
        
        function sideView() {
            if (typeof Plotly === 'undefined') return;
            Plotly.relayout('myDiv', {
                'scene.camera': {
                    eye: { x: 2.5, y: 0, z: 0.5 },
                    center: { x: 0, y: 0, z: 0 }
                }
            });
        }
        
        function saveImage() {
            if (typeof Plotly === 'undefined') return;
            Plotly.downloadImage('myDiv', {
                format: 'png',
                width: 1920,
                height: 1080,
                filename: 'edificios_3d_' + new Date().getTime()
            });
        }
        
        function toggleSpin() {
            if (spinning) {
                clearInterval(spinInterval);
                spinning = false;
            } else {
                spinning = true;
                spinInterval = setInterval(() => {
                    currentAngle += 2;
                    const radians = currentAngle * Math.PI / 180;
                    const distance = 2;
                    const height = 1.2;
                    
                    Plotly.relayout('myDiv', {
                        'scene.camera.eye': {
                            x: distance * Math.cos(radians),
                            y: distance * Math.sin(radians),
                            z: height
                        }
                    });
                }, 50);
            }
        }
        
        function autoAdjustView() {
            if (typeof Plotly === 'undefined') return;
            if (!plotData || !plotData.x || plotData.x.length === 0) return;
            
            const xRange = Math.max(...plotData.x) - Math.min(...plotData.x);
            const yRange = Math.max(...plotData.y) - Math.min(...plotData.y);
            const maxRange = Math.max(xRange, yRange);
            
            // Ajustar la distancia de la cámara según el rango de datos
            const cameraDistance = Math.max(maxRange / 200, 1);
            
            Plotly.relayout('myDiv', {
                'scene.camera.eye': {
                    x: cameraDistance * 1.5,
                    y: -cameraDistance * 1.5,
                    z: cameraDistance * 1.2
                }
            });
        }
        
        // Eventos de teclado
        document.addEventListener('keydown', (e) => {
            switch(e.key.toLowerCase()) {
                case 'r':
                    resetView();
                    break;
                case 't':
                    topView();
                    break;
                case 's':
                    sideView();
                    break;
                case ' ':
                    e.preventDefault();
                    toggleSpin();
                    break;
            }
        });
        
        // Verificar que Plotly se haya cargado correctamente
        function checkPlotlyAndInit() {
            if (typeof Plotly !== 'undefined') {
                console.log('Plotly cargado correctamente');
                loadSampleData();
            } else {
                console.error('Plotly no se ha cargado. Reintentando...');
                setTimeout(checkPlotlyAndInit, 500);
            }
        }
        
        // Esperar a que la página se cargue completamente
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', checkPlotlyAndInit);
        } else {
            checkPlotlyAndInit();
        }
        
    </script>
</body>
</html>
